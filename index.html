<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Item Shop</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://kit.fontawesome.com/a2e0e6ad5b.js" crossorigin="anonymous"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import {
      getFirestore, collection, getDocs, addDoc, deleteDoc,
      doc, query, where, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import {
      getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "YOUR_KEY",
      authDomain: "YOUR_DOMAIN",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_BUCKET",
      messagingSenderId: "YOUR_SENDER",
      appId: "YOUR_APP"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();

    const itemsRef = collection(db, "items");
    const reviewsRef = collection(db, "reviews");
    const feedbackRef = collection(db, "feedback");

    let currentItemId = null;

    // Spam filter words
    const bannedWords = ["spam", "scam", "fake", "badword"];
    function containsBannedWords(text) {
      return bannedWords.some(w => text.toLowerCase().includes(w));
    }

    function isAdmin() {
      const user = auth.currentUser;
      return user && user.email.endsWith("@admin.com");
    }

    // Render items
    async function renderItems() {
      const snapshot = await getDocs(itemsRef);
      const items = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      const container = document.getElementById("items");
      container.innerHTML = "";
      items.forEach(item => {
        container.innerHTML += `
          <div class="bg-purple-900 p-4 rounded-lg shadow-lg">
            <h3 class="text-xl font-bold text-white">${item.title}</h3>
            <p class="text-gray-300">${item.desc}</p>
            <button onclick="openReviews('${item.id}')" class="mt-2 bg-yellow-500 px-3 py-1 rounded">View Reviews</button>
            ${isAdmin() ? `<button onclick="deleteItem('${item.id}')" class="ml-2 text-red-400">Delete</button>` : ""}
          </div>
        `;
      });
    }

    // Reviews modal
    async function openReviews(itemId) {
      currentItemId = itemId;
      document.getElementById("reviewsModal").classList.remove("hidden");
      renderReviews(itemId);
    }

    async function renderReviews(itemId) {
      const snapshot = await getDocs(query(reviewsRef, where("itemId", "==", itemId), orderBy("timestamp", "desc")));
      const reviews = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      const list = document.getElementById("reviewsList");
      list.innerHTML = reviews.length ? "" : `<p class="text-gray-400">No reviews yet.</p>`;
      reviews.forEach(r => {
        const stars = "★".repeat(r.rating) + "☆".repeat(5 - r.rating);
        list.innerHTML += `
          <div class="bg-purple-800 p-3 rounded mb-2 flex justify-between">
            <div>
              <p class="text-yellow-400">${stars}</p>
              <p class="text-gray-200 font-bold">${r.name}</p>
              <p class="text-gray-300">${r.text}</p>
            </div>
            ${isAdmin() ? `<button onclick="deleteReview('${r.id}')" class="text-red-400 text-sm">Delete</button>` : ""}
          </div>
        `;
      });
    }

    async function addReview(e) {
      e.preventDefault();
      if (!currentItemId) return;
      const name = document.getElementById("reviewerName").value.trim();
      const text = document.getElementById("reviewText").value.trim();
      const rating = parseInt(document.getElementById("reviewRating").value);

      if (!name || !text) return alert("Fill all fields.");
      if (containsBannedWords(text)) return alert("Review contains banned words.");

      await addDoc(reviewsRef, {
        itemId: currentItemId, name, text, rating, timestamp: serverTimestamp()
      });
      e.target.reset();
      renderReviews(currentItemId);
    }

    async function deleteReview(id) {
      if (!confirm("Delete this review?")) return;
      await deleteDoc(doc(db, "reviews", id));
      renderReviews(currentItemId);
    }

    // Feedback
    async function sendFeedback(e) {
      e.preventDefault();
      const name = document.getElementById("feedbackName").value.trim();
      const message = document.getElementById("feedbackMessage").value.trim();
      if (!name || !message) return alert("Fill all fields.");
      if (containsBannedWords(message)) return alert("Feedback contains banned words.");
      await addDoc(feedbackRef, { name, message, timestamp: serverTimestamp() });
      e.target.reset();
      alert("Feedback sent. Thank you!");
    }

    async function renderFeedback() {
      if (!isAdmin()) return;
      const snapshot = await getDocs(query(feedbackRef, orderBy("timestamp", "desc")));
      const feedbacks = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      const list = document.getElementById("feedbackList");
      list.innerHTML = "";
      feedbacks.forEach(f => {
        list.innerHTML += `
          <div class="bg-purple-800 p-3 rounded mb-2 flex justify-between">
            <div>
              <p class="text-gray-200 font-bold">${f.name}</p>
              <p class="text-gray-300">${f.message}</p>
            </div>
            <button onclick="deleteFeedback('${f.id}')" class="text-red-400 text-sm">Delete</button>
          </div>
        `;
      });
    }

    async function deleteFeedback(id) {
      if (!confirm("Delete this feedback?")) return;
      await deleteDoc(doc(db, "feedback", id));
      renderFeedback();
    }

    // Auth
    onAuthStateChanged(auth, (user) => {
      document.getElementById("adminPanel").classList.toggle("hidden", !isAdmin());
      if (isAdmin()) renderFeedback();
    });

    async function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("loginPassword").value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
        toggleLogin();
      } catch (e) {
        alert("Login failed: " + e.message);
      }
    }

    async function logout() {
      await signOut(auth);
    }

    function toggleLogin() {
      document.getElementById("loginModal").classList.toggle("hidden");
    }

    // Init
    renderItems();
    window.openReviews = openReviews;
    window.addReview = addReview;
    window.deleteReview = deleteReview;
    window.sendFeedback = sendFeedback;
    window.deleteFeedback = deleteFeedback;
    window.login = login;
    window.logout = logout;
    window.toggleLogin = toggleLogin;
    window.deleteItem = deleteItem;
  </script>
</head>
<body class="bg-purple-950 text-white p-6">
  <h1 class="text-3xl font-bold mb-4">Item Shop</h1>
  <div id="items" class="grid gap-4"></div>

  <!-- Reviews Modal -->
  <div id="reviewsModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center">
    <div class="bg-purple-900 p-6 rounded-lg w-96">
      <h2 class="text-xl font-bold mb-3">Reviews</h2>
      <div id="reviewsList" class="mb-3"></div>
      <form id="reviewForm" onsubmit="addReview(event)" class="space-y-2">
        <input id="reviewerName" placeholder="Your Name" class="w-full p-2 rounded text-black">
        <textarea id="reviewText" placeholder="Write a review..." class="w-full p-2 rounded text-black"></textarea>
        <select id="reviewRating" class="w-full p-2 rounded text-black">
          <option value="5">★★★★★</option>
          <option value="4">★★★★</option>
          <option value="3">★★★</option>
          <option value="2">★★</option>
          <option value="1">★</option>
        </select>
        <button type="submit" class="bg-yellow-500 px-3 py-1 rounded w-full">Submit Review</button>
      </form>
      <button onclick="document.getElementById('reviewsModal').classList.add('hidden')" class="mt-3 text-gray-300">Close</button>
    </div>
  </div>

  <!-- Feedback Form -->
  <div class="mt-8 bg-purple-900 p-4 rounded">
    <h2 class="text-xl font-bold">Send Feedback</h2>
    <form id="feedbackForm" onsubmit="sendFeedback(event)" class="space-y-2">
      <input id="feedbackName" placeholder="Your Name" class="w-full p-2 rounded text-black">
      <textarea id="feedbackMessage" placeholder="Your feedback..." class="w-full p-2 rounded text-black"></textarea>
      <button type="submit" class="bg-green-500 px-3 py-1 rounded w-full">Send Feedback</button>
    </form>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="hidden mt-8 bg-purple-800 p-4 rounded">
    <h2 class="text-xl font-bold">Admin Feedback</h2>
    <div id="feedbackList"></div>
  </div>
</body>
</html>
