<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CorexCartel Shop</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-purple-900 via-purple-800 to-black text-gray-200 min-h-screen flex flex-col">

  <!-- Navbar -->
  <nav class="bg-purple-950/80 backdrop-blur-lg border-b border-purple-700 px-6 py-4 flex justify-between items-center shadow-lg">
    <h1 class="text-2xl font-extrabold text-purple-300 tracking-wider">CorexCartel Shop</h1>
    <button onclick="toggleLogin()" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded-lg text-white font-semibold transition">
      Admin Login
    </button>
  </nav>

  <!-- Products -->
  <section id="productsSection" class="flex-grow p-8">
    <h2 class="text-3xl font-bold text-purple-200 mb-6">Available Items</h2>
    <div id="itemsList" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </section>

  <!-- Item Detail Page -->
  <section id="itemDetailSection" class="hidden flex-grow p-8">
    <button onclick="goBack()" class="mb-6 text-purple-300 hover:text-purple-200 flex items-center">
      <i class="fas fa-arrow-left mr-2"></i> Back to Products
    </button>
    <div id="itemDetail" class="max-w-4xl mx-auto"></div>
    
    <!-- Reviews Section -->
    <div id="reviewsSection" class="max-w-4xl mx-auto mt-12">
      <h3 class="text-2xl font-bold text-purple-200 mb-4">Customer Reviews</h3>
      <div id="reviewsList" class="mb-6"></div>
      
      <!-- Add Review Form -->
      <div class="bg-purple-900 p-6 rounded-lg shadow-lg border border-purple-700">
        <h4 class="text-lg font-semibold text-purple-200 mb-4">Add Your Review</h4>
        <form onsubmit="addReview(event)" id="reviewForm">
          <div class="mb-4">
            <label class="block text-purple-300 mb-2">Your Name</label>
            <input id="reviewerName" class="border border-purple-600 bg-purple-800 text-white p-2 w-full rounded" placeholder="Enter your name" required />
          </div>
          <div class="mb-4">
            <label class="block text-purple-300 mb-2">Rating</label>
            <div class="flex space-x-1" id="ratingStars">
              <i class="far fa-star text-yellow-400 text-xl cursor-pointer" data-rating="1"></i>
              <i class="far fa-star text-yellow-400 text-xl cursor-pointer" data-rating="2"></i>
              <i class="far fa-star text-yellow-400 text-xl cursor-pointer" data-rating="3"></i>
              <i class="far fa-star text-yellow-400 text-xl cursor-pointer" data-rating="4"></i>
              <i class="far fa-star text-yellow-400 text-xl cursor-pointer" data-rating="5"></i>
            </div>
            <input type="hidden" id="reviewRating" value="5" required />
          </div>
          <div class="mb-4">
            <label class="block text-purple-300 mb-2">Review</label>
            <textarea id="reviewText" class="border border-purple-600 bg-purple-800 text-white p-2 w-full rounded" placeholder="Write your review here..." rows="4" required></textarea>
          </div>
          <button type="submit" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded text-white font-semibold transition">Submit Review</button>
        </form>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="bg-purple-950/80 border-t border-purple-700 p-4 text-center text-sm text-purple-300">
    © 2025 CorexCartel Shop. All rights reserved.
  </footer>

  <!-- Admin Login Modal -->
  <div id="loginModal" class="hidden fixed inset-0 bg-black/70 flex justify-center items-center z-50">
    <div class="bg-purple-950 p-8 rounded-xl shadow-xl w-96 border border-purple-700">
      <h2 class="text-xl font-bold text-purple-300 mb-4">Admin Login</h2>
      <input id="username" class="border border-purple-600 bg-purple-800 text-white p-2 w-full mb-3 rounded" placeholder="Username" />
      <input id="password" type="password" class="border border-purple-600 bg-purple-800 text-white p-2 w-full mb-4 rounded" placeholder="Password" />
      <button onclick="login()" class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded w-full font-semibold transition">Login</button>
      <button onclick="toggleLogin()" class="mt-3 text-sm text-purple-400 hover:text-purple-300 w-full">Cancel</button>
    </div>
  </div>

  <!-- Admin Dashboard -->
  <div id="adminPanel" class="hidden p-8 bg-purple-950 border-t border-purple-700">
    <h2 class="text-2xl font-bold text-purple-300 mb-6">Admin Dashboard</h2>

    <!-- Add Item -->
    <form onsubmit="addItem(event)" class="bg-purple-900 p-6 rounded-lg shadow-lg border border-purple-700 max-w-lg mb-8">
      <h3 class="text-lg font-semibold text-purple-200 mb-4">Add Item</h3>
      <input id="itemTitle" class="border border-purple-600 bg-purple-800 text-white p-2 w-full mb-3 rounded" placeholder="Item Title" required />
      <textarea id="itemDesc" class="border border-purple-600 bg-purple-800 text-white p-2 w-full mb-3 rounded" placeholder="Description" required></textarea>
      
      <div class="grid grid-cols-2 gap-3 mb-3">
        <div>
          <label class="block text-purple-300 mb-1">Price ($)</label>
          <input id="itemPrice" type="number" step="0.01" class="border border-purple-600 bg-purple-800 text-white p-2 w-full rounded" placeholder="USD" />
        </div>
        <div>
          <label class="block text-purple-300 mb-1">Price (Robux)</label>
          <input id="itemRobuxPrice" type="number" class="border border-purple-600 bg-purple-800 text-white p-2 w-full rounded" placeholder="Robux" />
        </div>
      </div>
      
      <input id="itemLink" class="border border-purple-600 bg-purple-800 text-white p-2 w-full mb-4 rounded" placeholder="Roblox Link" required />
      <button type="submit" class="bg-green-600 hover:bg-green-500 px-4 py-2 rounded text-white font-semibold transition w-full">Add Item</button>
    </form>

    <!-- Manage Admins -->
    <div class="bg-purple-900 p-6 rounded-lg shadow-lg border border-purple-700 max-w-2xl">
      <h3 class="text-lg font-semibold text-purple-200 mb-4">Admin Accounts</h3>
      <table class="w-full text-left border-collapse">
        <thead>
          <tr class="text-purple-300 border-b border-purple-700">
            <th class="p-2">Username</th>
            <th class="p-2">Password</th>
            <th class="p-2">Role</th>
            <th class="p-2">Actions</th>
          </tr>
        </thead>
        <tbody id="adminTable"></tbody>
      </table>
      <button id="addAdminBtn" onclick="createAdmin()" class="hidden mt-4 bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded text-white font-semibold transition">➕ Add New Admin</button>
    </div>
  </div>

  <!-- Firebase + App Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, doc, deleteDoc, updateDoc, query, where, orderBy } 
      from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAlDbDQ4R-rbNbs_yIezyTom6KESvFcsZE",
      authDomain: "corexcartel-shop.firebaseapp.com",
      projectId: "corexcartel-shop",
      storageBucket: "corexcartel-shop.appspot.com",
      messagingSenderId: "926705977434",
      appId: "1:926705977434:web:9d708c50ce66a9ae67f063"
    };

    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Refs
    const itemsRef = collection(db, "items");
    const adminsRef = collection(db, "admins");
    const reviewsRef = collection(db, "reviews");

    let currentAdmin = null;
    let currentItemId = null;

    // Hardcoded login credentials
    const loginAccounts = [
      { username: "mxybeyuli", password: "Qw7x!pL9z", role: "chief" },
      { username: "ben", password: "T8r@vB2kM", role: "chief" },
      { username: "kolify", password: "Zp3#nV6sQ", role: "normal" }
    ];

    // Render Items (Firestore)
    async function renderItems() {
      const snapshot = await getDocs(itemsRef);
      const items = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      const list = document.getElementById("itemsList");
      list.innerHTML = "";
      items.forEach(item => {
        list.innerHTML += `
          <div class="bg-purple-900 border border-purple-700 p-5 rounded-xl shadow-lg flex flex-col justify-between cursor-pointer hover:scale-105 transition-transform duration-300" onclick="showItemDetail('${item.id}')">
            <div>
              <h3 class="text-xl font-bold text-purple-200">${item.title}</h3>
              <p class="text-gray-400 mt-2 line-clamp-2">${item.desc}</p>
              <div class="mt-3 flex space-x-4">
                ${item.price ? `<p class="text-lg font-semibold text-green-400">$${item.price}</p>` : ''}
                ${item.robuxPrice ? `<p class="text-lg font-semibold text-yellow-400">${item.robuxPrice} Robux</p>` : ''}
              </div>
            </div>
            <div class="mt-4 flex justify-between items-center">
              <span class="text-purple-300 font-medium">Click to view details</span>
              ${currentAdmin ? `<button onclick="event.stopPropagation(); deleteItem('${item.id}')" class="adminBtn text-sm text-red-400 hover:text-red-300">Delete</button>` : ""}
            </div>
          </div>
        `;
      });
    }

    // Show Item Detail
    async function showItemDetail(itemId) {
      currentItemId = itemId;
      const docRef = doc(db, "items", itemId);
      const snapshot = await getDocs(itemsRef);
      const items = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      const item = items.find(i => i.id === itemId);
      
      if (item) {
        document.getElementById("productsSection").classList.add("hidden");
        document.getElementById("itemDetailSection").classList.remove("hidden");
        
        const itemDetail = document.getElementById("itemDetail");
        itemDetail.innerHTML = `
          <div class="bg-purple-900 border border-purple-700 p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-purple-200 mb-4">${item.title}</h2>
            <p class="text-gray-300 mb-6">${item.desc}</p>
            <div class="mb-6">
              ${item.price ? `<p class="text-xl font-semibold text-green-400">$${item.price}</p>` : ''}
              ${item.robuxPrice ? `<p class="text-xl font-semibold text-yellow-400">${item.robuxPrice} Robux</p>` : ''}
            </div>
            <div class="bg-purple-800 p-4 rounded-lg mb-6">
              <h3 class="text-lg font-semibold text-purple-200 mb-2">How to Purchase</h3>
              <p class="text-gray-300">To buy this item, please DM <span class="font-bold text-purple-300">@mxybeyuli</span> on Discord with the item name and your preferred payment method.</p>
            </div>
            <a href="${item.link}" target="_blank" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded-lg text-white font-semibold transition inline-block">View on Roblox</a>
          </div>
        `;
        
        // Load reviews for this item
        await renderReviews(itemId);
      }
    }

    // Go back to products
    function goBack() {
      document.getElementById("itemDetailSection").classList.add("hidden");
      document.getElementById("productsSection").classList.remove("hidden");
      currentItemId = null;
    }

    // Render Reviews
    async function renderReviews(itemId) {
      const q = query(reviewsRef, where("itemId", "==", itemId), orderBy("timestamp", "desc"));
      const snapshot = await getDocs(q);
      const reviews = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      const reviewsList = document.getElementById("reviewsList");
      
      if (reviews.length === 0) {
        reviewsList.innerHTML = '<p class="text-gray-400 italic">No reviews yet. Be the first to review this item!</p>';
        return;
      }
      
      reviewsList.innerHTML = reviews.map(review => `
        <div class="bg-purple-800 p-4 rounded-lg mb-4">
          <div class="flex justify-between items-center mb-2">
            <h4 class="font-semibold text-purple-200">${review.reviewerName}</h4>
            <span class="text-yellow-400">
              ${'★'.repeat(review.rating)}${'☆'.repeat(5-review.rating)}
            </span>
          </div>
          <p class="text-gray-300">${review.text}</p>
          <p class="text-gray-500 text-sm mt-2">${new Date(review.timestamp?.toDate()).toLocaleDateString()}</p>
        </div>
      `).join('');
    }

    // Add Review
    async function addReview(e) {
      e.preventDefault();
      if (!currentItemId) return;
      
      const reviewerName = document.getElementById("reviewerName").value;
      const rating = parseInt(document.getElementById("reviewRating").value);
      const text = document.getElementById("reviewText").value;
      
      await addDoc(reviewsRef, {
        itemId: currentItemId,
        reviewerName,
        rating,
        text,
        timestamp: new Date()
      });
      
      document.getElementById("reviewForm").reset();
      resetStars();
      await renderReviews(currentItemId);
      alert("Review submitted successfully!");
    }

    // Setup star rating
    function setupStarRating() {
      const stars = document.querySelectorAll('#ratingStars i');
      stars.forEach(star => {
        star.addEventListener('click', function() {
          const rating = parseInt(this.getAttribute('data-rating'));
          setStarRating(rating);
        });
        
        star.addEventListener('mouseover', function() {
          const rating = parseInt(this.getAttribute('data-rating'));
          highlightStars(rating);
        });
      });
      
      document.getElementById('ratingStars').addEventListener('mouseleave', resetStars);
    }
    
    function setStarRating(rating) {
      document.getElementById('reviewRating').value = rating;
      highlightStars(rating);
    }
    
    function highlightStars(rating) {
      const stars = document.querySelectorAll('#ratingStars i');
      stars.forEach((star, index) => {
        if (index < rating) {
          star.classList.remove('far');
          star.classList.add('fas');
        } else {
          star.classList.remove('fas');
          star.classList.add('far');
        }
      });
    }
    
    function resetStars() {
      const currentRating = parseInt(document.getElementById('reviewRating').value);
      highlightStars(currentRating);
    }

    // Render Admins (Firestore)
    async function renderAdmins() {
      const snapshot = await getDocs(adminsRef);
      const admins = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      const table = document.getElementById("adminTable");
      table.innerHTML = "";
      admins.forEach(admin => {
        table.innerHTML += `
          <tr class="border-b border-purple-700">
            <td class="p-2">${admin.username}</td>
            <td class="p-2">${admin.password}</td>
            <td class="p-2">${admin.role}</td>
            <td class="p-2">
              <button onclick="editAdmin('${admin.id}')" class="bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-white text-sm">Edit</button>
              ${currentAdmin?.role === "chief" ? `<button onclick="deleteAdmin('${admin.id}')" class="bg-red-600 hover:bg-red-500 px-3 py-1 rounded text-white text-sm ml-2">Delete</button>` : ""}
            </td>
          </tr>
        `;
      });
      if (currentAdmin?.role === "chief") {
        document.getElementById("addAdminBtn").classList.remove("hidden");
      }
    }

    // Login (local only)
    function login() {
      const user = document.getElementById("username").value;
      const pass = document.getElementById("password").value;
      const found = loginAccounts.find(a => a.username === user && a.password === pass);
      if (found) {
        currentAdmin = found;
        toggleLogin();
        document.getElementById("adminPanel").classList.remove("hidden");
        renderAdmins();
        renderItems();
        alert(`✅ Logged in as ${found.username} (${found.role})`);
      } else {
        alert("❌ Invalid credentials");
      }
    }

    // Add Item (Firestore)
    async function addItem(e) {
      e.preventDefault();
      const title = document.getElementById("itemTitle").value;
      const desc = document.getElementById("itemDesc").value;
      const price = document.getElementById("itemPrice").value;
      const robuxPrice = document.getElementById("itemRobuxPrice").value;
      const link = document.getElementById("itemLink").value;
      
      // Ensure at least one price is provided
      if (!price && !robuxPrice) {
        alert("Please provide at least one price (USD or Robux)");
        return;
      }
      
      await addDoc(itemsRef, { 
        title, 
        desc, 
        price: price || null, 
        robuxPrice: robuxPrice || null, 
        link 
      });
      renderItems();
      e.target.reset();
    }

    // Delete Item (Firestore)
    async function deleteItem(id) {
      if (confirm("Delete this item?")) {
        await deleteDoc(doc(db, "items", id));
        renderItems();
      }
    }

    // Edit Admin (Firestore)
    async function editAdmin(id) {
      const newUser = prompt("Enter new username:");
      const newPass = prompt("Enter new password:");
      if (newUser && newPass) {
        await updateDoc(doc(db, "admins", id), { username: newUser, password: newPass });
        renderAdmins();
      }
    }

    // Delete Admin (Firestore)
    async function deleteAdmin(id) {
      if (confirm("Delete this admin?")) {
        await deleteDoc(doc(db, "admins", id));
        renderAdmins();
      }
    }

    // Create Admin (Firestore)
    async function createAdmin() {
      const newUser = prompt("Enter new admin username:");
      const newPass = prompt("Enter new admin password:");
      let newRole = prompt("Enter admin role (normal/chief):", "normal");
      newRole = (newRole === "chief") ? "chief" : "normal";
      if (newUser && newPass) {
        await addDoc(adminsRef, { username: newUser, password: newPass, role: newRole });
        renderAdmins();
      }
    }

    // Toggle Login Modal
    function toggleLogin() {
      document.getElementById("loginModal").classList.toggle("hidden");
    }

    // Make functions global so onclick works
    window.login = login;
    window.toggleLogin = toggleLogin;
    window.addItem = addItem;
    window.deleteItem = deleteItem;
    window.createAdmin = createAdmin;
    window.editAdmin = editAdmin;
    window.deleteAdmin = deleteAdmin;
    window.showItemDetail = showItemDetail;
    window.goBack = goBack;
    window.addReview = addReview;

    // Initial load
    renderItems();
    setupStarRating();
  </script>

  <style>
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</body>
</html>
